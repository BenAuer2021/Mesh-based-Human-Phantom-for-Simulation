# Mesh-based Human (XCAT) Phantom for Simulation


## Description
Simulation studies have been essential for advancing various developments in imaging, dosimetry, and radiation therapy. 

The Geant4 application for tomographic emission (GATE) remains one of the most commonly used simulation toolkits in this context [GATE source page] (http://www.opengatecollaboration.org) [^1,2].

GATE supports the simulation of Positron Emission Tomography (PET), Single Photon Emission Computed Tomography (SPECT), X-ray Computed Tomography (CT), optical, and Compton camera imaging, radiation therapy, and dosimetry in the same environment [^2]. 

Most of the simulation software allows building system and phantom geometries based on the combination of simple idealized volumes. However, these volumes are limited to model accurately complex geometries. Recent GATE releases (version 8 and 9) alleviate these limitations by allowing the users to import triangulated surface meshes as stereo-lithography (STL) file format, thus enabling improved accuracy of simulation of system geometries.

Taking advantage of such capability, we developed a simplified STL-based version of the XCAT digitial anthropomorphic phantom providing an advanced anatomical description of the human body for simulation purposes.

In agreement with the original developer team of the XCAT phantom, we distribute below free of charge three versions of this phantom with different length (Head only, Head-Torso-Abdominal only, and Whole Body). 

We provide below a brief description of the phantoms in GATE. It is understandable that the phantom can be used in any software capable of importing STL files.

We refered readers interested on the generation, usage, and validation of this phantom in the context of brain SPECT to the following publications.

--> Note, the phantom can be used as well in Geant4 or any other software enabling importation of such STL files.

- Add references
- 50% percentile, weight, age, etc...
- Create a read me as the ICRP example for Geant4.

###### STL-based phantoms

We provide 3 versions of the phantom with different lengths (**Whole Body**, **Head-Torso-Abdominal Only**, and **Head Only**) as showed on the figure below.

<p align="center">
<img width="645" alt="Screen Shot 2022-06-02 at 4 41 26 PM" src="https://user-images.githubusercontent.com/84809217/171734381-dd43d63c-b9fa-44b8-b05b-e19b0a865efa.png">
</p>
  
The 3 phantom versions consist of the following structures,

- **Whole Body:**<br/>
  Body, Brain, Skeleton, Liver, Lungs, Air Cavity and Bronchi Tree. Note, the Air Cavity volume was generated by merging part of the throat, nasal and oral cavities, and trachea. These volumes were embedded into a structure, named 'Body' reflecting the outer surface of the phantom. Body was generated by unification of the head, ears, chest, arms, and legs into a single volume.
  | Structures | Size (cm x cm x cm) | Volumes (cm<sup>3</sup>) | # of Triangles | STL file size (MB) |
  |    :---     |     :---:  |     :---:     |    :---:      |    :---:  |
  | Body   | 65.8 x 28.0 x 176.4   | 73,781.8  | 12,148 | 0.61 |
  | Skeleton   | 64.0 x 25.4 x 175.0  | 6,539.1  | 73,832 | 3.7 |   
  | Air Cavity   | 5.9 x 14.0 x 26.7  | 141.3  | 3,830 | 0.19 | 
  | Brain   | 13.0 x 16.9 x 13.8  | 1,322.8  | 7,518 | 0.38 | 
  | Bronchi Tree  | 18.3 x 9.8 x 10.8  | 5.2  | 5,306 | 0.26 | 
  | Liver   | 18.9 x 19.1 x 18.7  | 1,798.7  | 3,698 | 0.18 | 
  | Lungs   | 24.1 x 18.0 x 22.1  | 2,804.7  | 5,354 | 0.27 | 

  <p align="center">
  <img width="952" alt="Screen Shot 2022-06-02 at 5 04 18 PM" src="https://user-images.githubusercontent.com/84809217/171738071-79ae77d3-0ec6-4713-b0e9-b70489f9a0f5.png">
  </p>
  
- **Head-Torso-Abdominal Only:**<br/> 
  Brain, Liver, Lungs, Bronchi Tree, Air Cavity and Part of the Body and the Skeleton within the head, torso, and abdominal region. 
  | Structures | Size (cm x cm x cm) | Volumes (cm<sup>3</sup>) | # of Triangles | STL file size (MB) |
  |    :---     |     :---:  |     :---:     |    :---:      |    :---:  |
  | Body (Head-Torso-Abd)  | 65.8 x 28.0 x 95.6   | 53,869.5  | 15,502 | 0.77 |
  | Skeleton (Head-Torso-Abd)   | 64.0 x 25.4 x 175.0  | 6,539.1  | 73,832 | 3.1 |   
  | Air Cavity   | 5.9 x 14.0 x 26.7  | 141.3  | 3,830 | 0.19 | 
  | Brain   | 13.0 x 16.9 x 13.8  | 1,322.8  | 7,518 | 0.38 | 
  | Bronchi Tree  | 18.3 x 9.8 x 10.8  | 5.2  | 5,306 | 0.26 | 
  | Liver   | 18.9 x 19.1 x 18.7  | 1,798.7  | 3,698 | 0.18 | 
  | Lungs   | 24.1 x 18.0 x 22.1  | 2,804.7  | 5,354 | 0.27 | 

  <p align="center">
  <img width="963" alt="Screen Shot 2022-06-02 at 5 05 29 PM" src="https://user-images.githubusercontent.com/84809217/171738203-c567aeeb-069b-4de8-b30b-03a0196dbef1.png">
  </p>
 
- **Head Only:**<br/>
  Brain and Part of the Body, Skeleton, and Air Cavity within the head region.
  | Structures | Size (cm x cm x cm) | Volumes (cm<sup>3</sup>) | # of Triangles | STL file size (MB) |
  |    :---     |     :---:  |     :---:     |    :---:      |    :---:  |
  | Body (Head) | 34.1 x 24.8 x 25.6   | 5,476.5 | 2,004 | 0.10 |
  | Skeleton (Head)   | 21.8 x 20.2 x 24.9  | 1,000.7  | 13,156 | 0.66 |   
  | Air Cavity (Head)   | 5.1 x 9.6 x 12.4  | 103.1  | 1,736 | 0.19 | 
  | Brain   | 13.0 x 16.9 x 13.8  | 1,322.8  | 7,518 | 0.38 | 

  <p align="center">
  <img width="862" alt="Screen Shot 2022-06-02 at 5 06 06 PM" src="https://user-images.githubusercontent.com/84809217/171738291-5b417726-5ea3-452e-90b2-b5876546448a.png">
  </p>

###### Voxelized version of the STL-based phantoms

We also provide voxelized versions in interfile format (16-bit unsigned integer, \*.i33 for raw data and \*.h33 for the header file) of the 3 STL-based phantoms described above. The voxelized phantoms can be used in attenuation correction for SPECT or PET reconstruction or as attenuation media or source definitionfor GATE simulation.

<p align="center">
<img width="1201" alt="Screen Shot 2022-06-05 at 2 51 39 PM" src="https://user-images.githubusercontent.com/84809217/172066089-1b02d124-c95c-4026-87d2-d52d7747ccf1.png">
</p>

The Body, Air Cavity, Brain, Bronchi Tree, Liver, Lungs, and Skeleton regions were set of values from 1 to 7 by increment of 1.

The STL-based phantoms were converted into voxelized phantoms following an approach similar to the one described in (Patil and Ravi, 2005). 

The voxelized attenuation phantoms were generated for a voxel size of 1 <sup>3</sup>. The Whole Body voxelized phantom was of 658x280x1764 <sup>3</sup> (size of 650 MB). The Head-Torso-Abdominal Only phantom was of 658x280x956 <sup>3</sup> (size of 352 MB). The Head Only phantom was of 338x248x256 <sup>3</sup> (size of 43 MB).

## Usage in GATE

###### STL-based phantoms

We provide a macro *'GateSTLPhantoms.mac'* to load and simulate in GATE the STL-based attenuation phantoms along with the voxelized source defined above. 

We desribe the GATE command lines to import the STL-based whole-body phantoms. Importation is similar for the Head and Head-Torso-Abdominal phantoms.
All the phantom internal structures (Skeleton, Liver, Lungs, Bronchi Tree, Brain, and Air Cavity) are part of the Body volume. The body volume can be set as a sub-volume of the world, SPECTHead, or any other volumes emcompassing its size. Examples of biological material composition from the ICRP and the ICRU of the STL-based human structures are provided below ([Geant4 ICRP110_HumanPhantoms Example](https://gitlab.physik.uni-kiel.de/geant4/geant4/-/blob/dab42d20185975fb0910dadfc6aa9998d9d9e06d/examples/advanced/ICRP110_HumanPhantoms/src/ICRP110PhantomMaterial_Male.cc), [GATE Example](https://github.com/OpenGATE/GateContrib/blob/master/dosimetry/Radiotherapy/example2/data/GateMaterials.db)). 


```ruby
/gate/SPECThead/daughters/name Body
/gate/SPECThead/daughters/insert tessellated
/gate/Body/geometry/setPathToSTLFile PATH_TO/Body.stl
/gate/Body/placement/setTranslation 0.0   0.0   0.0  cm
/gate/Body/setMaterial Water
/gate/Body/vis/setColor blue
/gate/Body/vis/forceSolid
/gate/Body/attachPhantomSD

/gate/Body/daughters/name Lung
/gate/Body/daughters/insert tessellated
/gate/Lung/geometry/setPathToSTLFile PATH_TO/Lung.stl
/gate/Lung/placement/setTranslation 0.0   0.0   0.0  cm
/gate/Lung/setMaterial Lung
/gate/Lung/vis/setColor blue
/gate/Lung/vis/forceSolid
/gate/Lung/attachPhantomSD

/gate/Body/daughters/name Skeleton
/gate/Body/daughters/insert tessellated
/gate/Skeleton/geometry/setPathToSTLFile PATH_TO/Skeleton.stl
/gate/Skeleton/placement/setTranslation 0.0   0.0   0.0  cm
/gate/Skeleton/setMaterial SpineBone
/gate/Skeleton/vis/setColor cyan
/gate/Skeleton/vis/forceSolid
/gate/Skeleton/attachPhantomSD

/gate/Body/daughters/name Brain
/gate/Body/daughters/insert tessellated
/gate/Brain/geometry/setPathToSTLFile PATH_TO/Brain.stl
/gate/Brain/placement/setTranslation 0.0   0.0   0.0  cm
/gate/Brain/setMaterial Brain
/gate/Brain/vis/setColor cyan
/gate/Brain/vis/forceSolid
/gate/Brain/attachPhantomSD

/gate/Body/daughters/name Liver
/gate/Body/daughters/insert tessellated
/gate/Liver/geometry/setPathToSTLFile PATH_TO/Liver.stl
/gate/Liver/placement/setTranslation 0.0   0.0   0.0  cm
/gate/Liver/setMaterial Liver
/gate/Liver/vis/setColor cyan
/gate/Liver/vis/forceSolid
/gate/Liver/attachPhantomSD

/gate/Body/daughters/name AirCavity
/gate/Body/daughters/insert tessellated
/gate/AirCavity/geometry/setPathToSTLFile PATH_TO/Air_cavity.stl
/gate/AirCavity/placement/setTranslation 0.0   0.0   0.0  cm
/gate/AirCavity/setMaterial Air
/gate/AirCavity/vis/setColor cyan
/gate/AirCavity/vis/forceSolid
/gate/AirCavity/attachPhantomSD
```

The *Bronchi Tree* is a subvolume of the Lung volume,
```ruby
/gate/SPECThead/daughters/name Body
/gate/SPECThead/daughters/insert tessellated
/gate/Body/geometry/setPathToSTLFile PATH_TO/Body.stl
/gate/Body/placement/setTranslation 0.0   0.0   0.0  cm
/gate/Body/setMaterial Water
/gate/Body/vis/setColor blue
/gate/Body/vis/forceSolid
/gate/Body/attachPhantomSD
``` 

###### Voxelized version of the STL-based phantoms

The voxelized phantoms (interfile format) can be loaded in GATE via the following command lines, where 'VoxSource' is the source volume name,
```ruby
/gate/source/addSource                                            VoxSource voxel
/gate/source/VoxSource/reader/insert                              image
/gate/source/VoxSource/imageReader/translator/insert              linear
/gate/source/VoxSource/imageReader/linearTranslator/setScale      0.001 Bq
/gate/source/VoxSource/imageReader/readFile PATH_TO/WholeBody_Assembled_658x280x1764.h33 
# OR Head_Assembled_338x248x256 OR HeadTorsoAbd_Assembled_658x280x956
/gate/source/VoxSource/imageReader/verbose 1
/gate/source/VoxSource/gps/particle gamma
/gate/source/VoxSource/gps/angtype iso
/gate/source/VoxSource/gps/energy 140.5 keV # For Tc-99m
```
The default position of the voxelized source is in the 1<sup>st</sup> quarter, so the voxelized source has to be shifted over half its dimension in the negative direction on each axis. As the voxel size is 1 mm<sup>3</sup>, dimensions of the image (*provided in the file name*) need to be divided by two along X, Y, Z dimensions.

This results in the addition of the following two lines,

```ruby
/gate/source/hof_brain/setPosition -329.0 -140.0 -882.0 mm
/gate/source/list
```

The voxelized phantoms can also be used as attenuation map in GATE via the following command lines. Note, the voxelized phantom should not collide with any other system components and be contained entirely within its 'mother' volume. The voxelized phantom can be a sub-volume of the SPECThead volume as shown below, 
```ruby
/gate/SPECThead/daughters/name VoxAttn
/gate/SPECThead/daughters/insert ImageRegularParametrisedVolume
/gate/VoxAttn/geometry/setImage PATH_TO/WholeBody_Assembled_658x280x1764.h33
/gate/VoxAttn/geometry/setRangeToMaterialFile AttnRange.dat
/gate/VoxAttn/placement/setTranslation  0. 0. 0. mm
/gate/VoxAttn/setSkipEqualMaterials 1
/gate/VoxAttn/attachPhantomSD
```
Indices in the voxelized image are translated into material via the parameters defined in the 'AttnRange.dat' file. For example, we recommend the following indices to materials conversion,

  | Image Indices | Human Structures | Biological material |
  |    :---     |     :---:  |     :---:     |
  | 0 |  Volume surrounding the body region of the phantom  | *Air* |
  | 1   | Body  | *Water*  |
  | 2   | Air Cavity  | *Air*  | 
  | 3   | Brain  | *Brain*  |
  | 4   | Bronchi Tree  | *Air*  |
  | 5   | Liver  | *Liver*  |
  | 6   | Lungs  | *Lung*  |  
  | 7   | Skeleton  | *SpineBone*  |  
  
  Note, the biological materials are defined in the 'GateMaterials.db' file.

## Citation of the following articles if used

## Download


[^1]: Jan et al., 2004.
[^2]: Sarrut et al., 2014.

